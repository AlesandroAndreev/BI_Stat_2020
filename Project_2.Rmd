---
title: "Second Project. Отчет о построении первичной модели прогнозирования стоимости недвижимости в Бостоне"
output:
 html_document:
  toc: true
  toc_depth: 2
  toc_float: true
  number_section: true
---
#  Введение
В начале анализа произведем загрузку всех необходимых пакетов для оценки и визуализации исследуемых данных. Список пакетов указан ниже:

```{r packeges, echo=FALSE, message  =  FALSE, warning=FALSE}

require(MASS)
require(psych)
require(ggplot2)
require(dplyr)
require(car)
require(purrr)
require(tidyr)
require(tidyverse)
require(PerformanceAnalytics)
require(qqplotr)
require(gridExtra)

```

После того, как весь инструментарий был загружен визуально, оценим исследуемый набор данных применив функцию head(), чтобы не нагромождать вывод. 

```{r see_the_data, echo=FALSE, message  =  FALSE, warning=FALSE}

data("Boston")
analys <- Boston

head(analys)

str(analys)
```

Становится видно, что изучаемый "dataframe" содержит в себе 14 переменных, имеющих следующее содержание:

1. crim - уровень преступности на душу населения по городам;

2. zn - доля земли под жилую застройку, зонированная под участки площадью более 25000 кв. футов;

3. indus - доля акров, не относящихся к розничной торговле, на город;

4. chas -  фиктивная переменная Charles River (= 1, если участок ограничивает реку; 0 если нет);

5. nox - концентрация оксидов азота (частей на 10 млн);

6. rm - среднее количество комнат в доме;

7. age - доля занятых владельцами единиц, построенных до 1940 года;

8. dis - средневзвешенное расстояние до пяти бостонских центров занятости;

9. rad - индекс доступности радиальных автомобильных дорог;

10. tax  - полная ставка налога на имущество за каждые 10 000 долларов;

11. ptratio - соотношение учеников и учителей по городам;

12. black - 1000 (Bk - 0,63) ^ 2, где Bk - доля черных по городу;

13. lstat - более низкий статус населения (в процентах);

14. medv - медианная стоимость домов, занимаемых владельцами, составляет 1000 долларов.

Основной целью, поставленной в рамках данного отчета, является постройка линейной модели зависимости средней стоимости домов (переменная medv), занимаемых владельцами от различных факторов. Для достижения цели работы были утверждены следующие задачи:

* Постройте полную линейную модель, предварительно применив
стандартизацию предикторов. В модели не надо учитывать взаимодействия
предикторов.

* Проведите диагностику данной модели:

   + Проверка линейности взаимосвязи;
   + Проверка влиятельных наблюдений;
   + Независимость наблюдений;
   + Нормальность распределения и постоянство дисперсии.
   
* Постройте график предсказаний стоимости от переменной, которая обладает 
наибольшим по модулю коэффициентом.

# Подготовка данных
Первоначально необходимо сделать несколько приготовлений для постройки модели: опредилиться с типом используемых переменных, проверить исследуемых набор данных на наличе пропущенных значений и оценить характер распределения и корреляции переменных между собой.

В описании действий, которые необходимо выполнить перед постройкой модели, не случайно было сказано об определении характера переменных. Так, из описания и взгляда на данные становится видно, что переменная chas является номинативной и, следовательно, должна быть переведина в фактор. Второй переменной, которая могла бы быть фактором является rad. Однако, если вчитаться в описание, то становится видно, что, чем больше значение rad, тем большая доступность радиальной автомобильной доорги,таким образом, данная переменная является порядковой и ее положжение является неоднозначным.В следствии этого было принято решения: не осуществлять никаких преобразований со столбцом rad до постройки первоначальной модели. Возможно, преобразования понадобятся в дальнейшем для анализа основных компонент (PCA).

Выполним все необходимые преобрназования,выведем основные статистики и проверим набор данных на наличие пропущенных значений: 


1) Основные статистики:

```{r start, echo=FALSE, message  =  FALSE, warning=FALSE}

analys$chas <- as.factor(analys$chas)
chas <- analys$chas
summary(analys)

```

2) Наличие пропущенных значений:
```{r isna, echo=FALSE, message  =  FALSE, warning=FALSE}
sum(is.na(analys))
```

3) Наличие дублирущихся строк:
```{r dubles, echo=FALSE, message  =  FALSE, warning=FALSE}
sum(duplicated(analys))
```

4) Выведем гистограммы данных разделенных в зависимости от ограничения участком реки (chas):
```{r graph_1, echo=FALSE, message  =  FALSE, warning=FALSE}

analys %>%
  gather( -chas, key = "var", value = "value") %>%
  ggplot(aes(x = value, fill = chas)) +
  geom_histogram(na.rm = TRUE, alpha = 0.5) +
  facet_wrap(~ var, scales = "free") +
  theme_bw()+
  ggtitle("Density plot of values by chas")+
  xlab("Values")+
  ylab("Density")+
  theme(plot.title = element_text(hjust = 0.5,size = 20))+
  theme(axis.title.x = element_text(size = 15))+
  theme(axis.title.y = element_text(size = 15))
```

Визуализируем график разброса зависимых переменных от медианной стоимости домов:

```{r graph_2, echo=FALSE, message  =  FALSE, warning=FALSE}

Boston %>%
  gather(key, val, -medv) %>%
  ggplot(aes(x = val, y = medv)) +
  geom_point() +
  stat_smooth(method = "lm", se = TRUE, col = "blue") +
  facet_wrap(~key, scales = "free") +
  theme_gray() +
  ggtitle("Scatter plot of dependent variables vs Median Value (medv)") 
```

Согласно визуализации, можно судить о том, что доля домов, занимаемых владельцами, построенных до 1940 года, и доля чернокожих по городам сильно смещены влево, в то время, как уровень преступности на душу населения в городе и средневзвешенное расстояние до пяти Бостонских центров занятости сильно смещен вправо. rm обычно распределяется со средним значением примерно 6. Большинство объектов недвижимости расположены недалеко от пяти Бостонских центров занятости.  93% собственности находятся вдали от реки Чарльз. Недвижимость, граничащая с рекой, кажется, имеет более высокие средние цены.

Теперь посмотрим,как переменные соотносятся между собой через построение корреляционной матрицы:

```{r graph_cor, echo=FALSE, message  =  FALSE, warning=FALSE}

chart.Correlation(analys[,c(-4)], histogram=TRUE, pch=18)
```

Глядя на графики корелляцийБ можно сделать вывод, что средняя стоимость домов, занимаемых владельцами увеличивается по мере увеличения среднего количества комнат на жилище и уменьшается, если процент населения с более низким статусом в этом районе увеличивается, т.е. lstat и rm показывают сильную корреляцию с medv.

Концентрация оксидов азота возрастает с увеличением доли акров, не связанных с розничной торговлей, на город и доли жилых единиц, построенных до 1940 года. Индекс доступности радиальных автомобильных дорог и полная ставка налога на имущество за каждые 10000\$ долларов имеют сильную положительную корреляцию, равную 0,91, это означает, что по мере увеличения доступности радиальных автомагистралей полная стоимость налога на имущество из расчета на 10000\$ также увеличивается.

Уровень преступности на душу населения по городам тесно связан с переменными rad и tax, это означает, что по мере увеличения доступности радиальных автомагистралей, уровень преступности на душу населения увеличивается.

indus имеет сильную положительную корреляцию с nox, что подтверждает мнение о высокой концентрации оксидов азота в промышленных зонах.


# Построение полной линейной модели и ее оценка

## Построение полной линейной модели

Перед тем как начать строить линейную модель необходимо стандартизироваь придикторы для того, чтобы осуществить сравнение вклада различных предикторов в линейную модель.

```{r scale, echo=FALSE, message  =  FALSE, warning=FALSE}

data_scale <- as.data.frame(sapply(analys[,c(1:3,5:14)], scale)) %>%
  cbind(chas)
```

Построим полную регрессионную модель:
```{r cor_model1, echo=FALSE, message  =  FALSE, warning=FALSE}
model_full <- lm(medv ~ ., data = data_scale)
summary(model_full)
```
Как видно из описания модели, наиболее значимый вклад в предсказание вносит переменная lstat, что согласуется с тем фактом, что корелляция medv и lstat является наиболее сильной. Также следует отметить, что влияние переменных  indus и age является не очень значимым .

Попробуем осуществить подбор наиболее значимых коофициентов для увеличения предсказательной силы модели. Автокорелляции пока что учитывать не будем:

Создадим полную и нулевую модель и осуществим подбор коофициентов при помощи метода step() с параметрами "forward" и "backward" и both и совмещенного варианта.

```{r cor_model2, echo=FALSE, message  =  FALSE, warning=FALSE}
nullmodel <- lm(medv ~ 1, data = data_scale)
fullmodel <- lm(medv ~ ., data = data_scale)



```

Для прямого отбора:

```{r cor_model_f, echo=FALSE, message  =  FALSE, warning=FALSE}

model_forward <- step(nullmodel, scope = list(lower = nullmodel, upper = fullmodel), direction = "forward")
summary(model_forward)

```

```{r cor_model_b, echo=FALSE, message  =  FALSE, warning=FALSE}

model_backward<- step(fullmodel, direction = "backward")
summary(model_backward)
```

Совмещенный вариант:

```{r cor_model_bf, echo=FALSE, message  =  FALSE, warning=FALSE}

model_both <- step(nullmodel, scope = list(lower = nullmodel, upper = fullmodel), direction = "both")
summary(model_both)

```
Действительно, в данном случае без учета автокорелляций мы можем отбросить исключительно параметры indus и age, как не очень значимые.

### Проверка полученной модели

Теперь, когда модель готова осуществим ее диагностику:

#### Проверка линейности взаимосвязи

Для проверки полученной модели на линейность построим quantile-quantile plot для остатков:



```{r linear, echo=FALSE, message  =  FALSE, warning=FALSE}

finish_model <- data.frame(fortify(model_both), data_scale[, c(3,6)])



qqPlot(finish_model$.stdresid,ylab = "model quantiles",id = F)

```

Как можно наблюдать из графика, взаимосвязь между medv и предикторами не является полностью линейной. 

#### Проверка влиятельных наблюдений

Построим график расстояний Кука:

```{r kuk, echo=FALSE, message  =  FALSE, warning=FALSE}

ggplot(finish_model, aes(x = 1:nrow(finish_model), y = .cooksd)) + 
  geom_bar(stat = "identity") + 
  geom_hline(yintercept = 2, color = "red")

ggplot(finish_model, aes(x = 1:nrow(finish_model), y = .cooksd)) + 
  geom_bar(stat = "identity") + 
  geom_hline(yintercept = 2, color = "red")+
  ylim(0,0.075)

```

Граффик расстояний Кука демонстрирует наличие значимых наблюдений. Однако, сила их влияния не очень велика, поскольку ни одно из расстояний Кука не привышает значения в единицу.

#### Независимость наблюдений и постоянство дисперсии

Построим график распределения остатков:

```{r resid, echo=FALSE, message  =  FALSE, warning=FALSE}

resid <- ggplot(data = finish_model, aes(x = .fitted, y = .stdresid)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  geom_smooth(method = "lm") +
  geom_hline(yintercept = 2, color = "red") +
  geom_hline(yintercept = -2, color = "red")

resid2 <- ggplot(data = finish_model, aes(x = .fitted, y = .stdresid)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  geom_smooth() +
  geom_hline(yintercept = 2, color = "red") +
  geom_hline(yintercept = -2, color = "red")

grid.arrange(resid,resid2, nrow = 2)
```

Также построим графики от предикторов, не вошедших в модель:

```{r pred, echo=FALSE, message  =  FALSE, warning=FALSE}

one <- resid + aes(x = indus)
two <- resid + aes(x = age)

grid.arrange(one,two, nrow = 2)
```

На графике остатков мы видим значительные выбросы.Можно сделать выводы о наличии автокорелляций и не гетерогенности дисперсии. Исключенные  переменные не имеют скрытых влияний на модель.

# Постройте график предсказаний стоимости от переменной, которая обладает наибольшим по модулю коэффициентом

Как было установленно ранее, наиболее значимой переменной в построенной линейной модели являтся более низкий статус населения.

Для того,чтобы осуществить моделирование необходимо создать искуственный набор данных. Сделаем это и выведим результаты на экран:

```{r modeling, echo=FALSE, message  =  FALSE, warning=FALSE}

Predict_data <- data.frame(
  black = mean(data_scale$black),
  ptratio = mean(data_scale$ptratio),
  chas = as.factor(sample(c(0), replace=TRUE, size=100)),
  rm = mean(data_scale$lstat),
  lstat = seq(min(data_scale$lstat), max(data_scale$lstat), length.out = 100),
  dis = mean(data_scale$dis),
  crim = mean(data_scale$crim),
  zn = mean(data_scale$zn),
  nox = mean(data_scale$nox),
  rad = mean(data_scale$rad),
  tax = mean(data_scale$tax))

str(Predict_data)
```

После того, как данные смоделированы, применим на них модель и построим графики:

```{r modeling2, echo=FALSE, message  =  FALSE, warning=FALSE}

Predictions <- predict(model_both, newdata = Predict_data,  interval = 'confidence')
Predict_data <- data.frame(Predict_data, Predictions)

Pl_predict <- ggplot(Predict_data, aes(x = lstat, y = fit)) +
  geom_ribbon(alpha = 0.2, aes(ymin = lwr, ymax = upr)) +
  geom_line() + 
  ggtitle("Множественная модель")
Pl_predict 
```

Таким образом, была получена молель предсказания стоимости от переменной, которая обладает наибольшим по модулю коэффициентом. Следует отметить, что данная модель не является рабочий в силу нелинейной связи между прогнозируем значением и предиктрами. Для увеличения качества предсказания рекомендуется применение PCA - анализа.










